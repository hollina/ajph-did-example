{
  "hash": "57214781feac252b7859da1463591282",
  "result": {
    "markdown": "---\ntitle: \"Antibiotics and mortality\"\n---\n\n\n## Load packages\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: pacman\n```\n:::\n:::\n\n\n## Load AEJ-Applied data\n\nLet's start by loading in the simplest data. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nstate_mortality = haven::read_dta(\"data/raw/113743-V1/AEJApp-20080229_Datasets/20080229_state_data.dta\")\nstate_mortality = as.data.table(state_mortality)\n\n\nnational_mortality = haven::read_dta(\"data/raw/113743-V1/AEJApp-20080229_Datasets/20080229_national_data.dta\")\nnational_mortality = as.data.table(national_mortality)\nnational_mortality[,one:=1]\nnational_mortality[,two:=2]\n```\n:::\n\n\nQuick look at the data\n\n::: {.cell}\n\n```{.r .cell-code}\nflu_plot = ggplot(data = national_mortality, aes(x = year, y = log(influenza_pneumonia_total), shape = as.factor(one))) + \n    geom_point(size = 3, alpha = .75) + \n    theme_classic(base_size = 14) +\n    geom_vline(xintercept = 1937, linetype=\"dashed\") +\n    labs(title = \"Influenza and pneumonia mortality rate across time\", \n         y = \"\", \n         subtitle = \"Death rate per 100,000\",\n         x = \"Year\") +\n    theme(legend.position = \"none\") \n\nflu_plot\n```\n\n::: {.cell-output-display}\n![](ajph-did-example_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nflu_plot +\n    geom_point(data = national_mortality, aes(x = year, y = log(tuberculosis_total), shape = as.factor(two)), size = 3, alpha = .75) +\n        theme_classic(base_size = 14) +\n    labs(title = \"Mortality rate across time\", \n         y = \"\", \n         subtitle = \"Death rate per 100,000\",\n         x = \"Year\") +\n      scale_shape_manual(name = \"\", values=c(16, 17), labels = c(\"Influenza/pneumonia\", \"Tuberculosis\"),  guide = 'legend') + \n  theme(legend.position = c(.8, 1))\n```\n\n::: {.cell-output-display}\n![](ajph-did-example_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\n## Do simple diff in diff. \n\n::: {.cell}\n\n```{.r .cell-code}\nstate_mortality_reshape = melt(state_mortality, id.vars = c(\"state_pc\", \"year\"),\n                measure.vars = c(\"tb_rate\", \"infl_pneumonia_rate\"))\n\nstate_mortality_reshape[, treated_disease := ifelse(variable == \"tb_rate\", 0, 1)]\nstate_mortality_reshape[, treated_time := ifelse(year >= 1937, 1, 0)]\nstate_mortality_reshape[, treated := treated_time*treated_disease]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsimple_did = fixest::feols(log(value)  ~ treated | treated_disease + state_pc + year, \n              data = state_mortality_reshape)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nNOTE: 96 observations removed because of NA values (LHS: 96).\n```\n:::\n\n```{.r .cell-code}\netable(simple_did)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                          simple_did\nDependent Var.:           log(value)\n                                    \ntreated         -0.0632*** (2.37e-8)\nFixed-Effects:  --------------------\ntreated_disease                  Yes\nstate_pc                         Yes\nyear                             Yes\n_______________ ____________________\nS.E.: Clustered  by: treated_disease\nObservations                   2,696\nR2                           0.87465\nWithin R2                    0.00505\n---\nSignif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n```{.r .cell-code}\nsimple_did$coeftable[1,1]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] -0.06316098\n```\n:::\n:::\n\n\n\n## Create fake treatment groups. \n\nAdd random variable to each state to get fake treated_year\n\n::: {.cell}\n\n```{.r .cell-code}\nstate_mortality[, rand:=runif(1, 0, 1), by = state_pc]\nstate_mortality[, fake_year_treated := ifelse(rand < .33, 1930, ifelse(rand > .66, 1940, 1937)), by = state_pc]\nstate_mortality[, year_before_1937 := ifelse(year < 1937, year, 0)]\nstate_mortality[, year_after_1937 := ifelse(year >= 1937, year, 0)]\n```\n:::\n\n\nNow for states that are fake treated not in 1937, we need fake data. \n\nGet pre-treatment trend and s.d. from the flu trend\n\n::: {.cell}\n\n```{.r .cell-code}\nstate_trend_inf = fixest::feols(log(infl_pneumonia_rate)  ~ year | 1, \n              data = subset(state_mortality, year < 1937 & year > 1927))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nNOTE: 2 observations removed because of NA values (LHS: 2).\n```\n:::\n\n```{.r .cell-code}\netable(state_trend_inf)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                         state_trend_inf\nDependent Var.: log(infl_pneumonia_rate)\n                                        \nConstant                47.03*** (8.902)\nyear                 -0.0278*** (0.0046)\n_______________ ________________________\nS.E. type                            IID\nObservations                         421\nR2                               0.08020\nAdj. R2                          0.07801\n---\nSignif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n```{.r .cell-code}\ncoef_inf = state_trend_inf$coeftable[2,1]\nse_inf = state_trend_inf$coeftable[2,2]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nstate_trend_tb = fixest::feols(log(tb_rate)  ~ year | 1, \n              data = subset(state_mortality, year < 1937 & year > 1927))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nNOTE: 2 observations removed because of NA values (LHS: 2).\n```\n:::\n\n```{.r .cell-code}\netable(state_trend_tb)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                     state_trend_tb\nDependent Var.:        log(tb_rate)\n                                   \nConstant           96.01*** (16.70)\nyear            -0.0535*** (0.0086)\n_______________ ___________________\nS.E. type                       IID\nObservations                    421\nR2                          0.08387\nAdj. R2                     0.08169\n---\nSignif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n```{.r .cell-code}\ncoef_tb = state_trend_tb$coeftable[2,1]\nse_tb = state_trend_tb$coeftable[2,2]\n```\n:::\n\n\nCreate state-specific trend that\n\n::: {.cell}\n\n```{.r .cell-code}\ntemp = subset(state_mortality, year == 1928)\ntemp = temp[,.(state_pc, infl_pneumonia_rate, tb_rate, fake_year_treated)]\ntemp2 = data.table(expand.grid(year=1928:1950, state_pc =unique(temp$state_pc)))\ntemp3 = merge(temp, temp2, by = \"state_pc\")\nfake_data = melt(temp3, id.vars = c(\"state_pc\", \"year\", \"fake_year_treated\"),\n                measure.vars = c(\"tb_rate\", \"infl_pneumonia_rate\"))\n\nfake_data[, treated_disease := ifelse(variable == \"tb_rate\", 0, 1)]\nfake_data[, treated_time := ifelse(year >= fake_year_treated, 1, 0)]\nfake_data[, treated := treated_time*treated_disease]\n\n\nfake_data[, fake_value := ifelse(variable == \"tb_rate\", (value)*(1 + (year-1928)*coef_tb), (value)*(1 + (year-1928)*coef_inf))]\n\nfake_data[, fake_value := ifelse(treated == 1, fake_value*(1 + simple_did$coeftable[1,1]), fake_value)]\n\nfake_data[, fake_value := ifelse(fake_value < 0, 0, fake_value)]\n```\n:::\n\n\nCollapse data to timing group\n\n::: {.cell}\n\n```{.r .cell-code}\ncollapsed_fake_data = collap(fake_data, ~ treated_disease + year + fake_year_treated, fmean, cols = 9)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nflu_plot_fake = ggplot(data = subset(collapsed_fake_data, treated_disease == 1), aes(x = year, y = log(fake_value), shape = as.factor(fake_year_treated))) + \n    geom_point(size = 3, alpha = .4) + \n    theme_classic(base_size = 14) +\n    geom_vline(xintercept = 1936.5, linetype=\"dashed\") +\n    geom_vline(xintercept = 1929.5, linetype=\"dashed\") +\n    geom_vline(xintercept = 1939.5, linetype=\"dashed\") +\n    labs(title = \"Influenza and pneumonia mortality rate across time\", \n         y = \"\", \n         subtitle = \"Death rate per 100,000\",\n         x = \"Year\") +\n    theme(legend.position = \"none\") \n\nflu_plot_fake\n```\n\n::: {.cell-output-display}\n![](ajph-did-example_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n\n# run event study regression\n\n::: {.cell}\n\n```{.r .cell-code}\nstate_mortality_reshape[, years_until_treat := ifelse(treated_disease == 0, -1,  1937 - year)]\n\nes_real = fixest::feols(log(value)  ~ i(years_until_treat, ref=-1) | treated_disease + state_pc + year, \n              data = state_mortality_reshape)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nNOTE: 96 observations removed because of NA values (LHS: 96).\n```\n:::\n:::\n",
    "supporting": [
      "ajph-did-example_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}